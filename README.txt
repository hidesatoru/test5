スピードテストアプリ

◇はじめに

私はバイクを自分で整備するためセッティングの状態を確認する補助として
このアプリを製作しました。

◇概要

開始ボタンを押すとGPSが起動し速度を取得し始めます。
データ取得をし値を数値のところへ描画していきます。
グラフの値が増えるとグラフ描画がずれるように作りました。
画面回転にも対応させてます。
ファイル保存にも対応させました、ファイル形式は後の編集を考えcsvとしています。
当然ファイル保存をするので読み込みも可能となってます。
利便性を考えアプリ内でファイル削除もできるようになってます。

◇使用技術

値をグラフにするためグラフ表示用のオープンソースの使用を検討しましたが、
自分で制作することに変更しました。

値が増えていくにつれて新たな値をグラフ内に収めながら描画する方法について、画面の大きさを取得し、
画面の大きさからX軸の最大の長さを計算し、軸の長さを値の数で割り一つの値の長さを計算し描画する方法を考え作りましたが、
なぜか値が増えるにつれて描画タイミングがずれてしまう問題が発生し残ってしまっています。

バックグラウンドでGPSを動かすためにhandlerの使用を考え処理を実行させたが、正常に動作しませんでした。

調べた結果androidバージョン8.0からバックグランド処理に制限がかかり、
バックグランドでは値の取得が１時間に数回程度しか行われなくなっていました。
また、androidバージョン10.0からフォアグランド処理としてステータスバーアイコンにGPSアイコンを表示しないと
GPSが自動で停止してしまう制限かかかっていました。

そのためGPSをフォアグランドサービスで実行するため新たにクラスを作りフォアグランドサービスとして起動させようとしたが、
サービスクラス内で実装しているリスナーでグラフ描画クラスを処理する方法が見つからず
サービスクラス内にGPS動作と処理をまとめる方法が分からなかったため、
GPS起動と値の処理をMainActivityで処理し、ステータスバーアイコンのみフォアグランドサービスで起動し表示する形となりました。
バージョン制限で処理を変更し、8.0以前のバージョンの処理を実装していないため、
androidバージョン8.0以降でないと動かない状態になってます。

画面を回転させると再起動扱いとなりデータが初期化されてしまう問題があり、画面を縦か横に固定する方法もありましたが、
どうせなら回転に対応できるようにしようと思い、再起動扱いとなる設定を変更し再起動しないようにしました。
しかし、そうすると処理は続けて行っているが、グラフなどの表示は回転前の表示から変わらないためレイアウトが崩れてしまいました。
そこで画面回転前に現状のデータを内部ストレージに保存し、画面回転後、画面回転を検知して処理をするメソッドを呼び出し、
その中に画面の大きさを再取得し内部ストレージに保存したデータを読み込み描画しなおす処理を加え画面回転に対応するようになりました。
